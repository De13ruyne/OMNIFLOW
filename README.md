# OmniFlow v2.5: ç”Ÿäº§çº§åˆ†å¸ƒå¼ç”µå•†å±¥çº¦ç³»ç»Ÿ

![Go](https://img.shields.io/badge/Go-1%2E21+-00ADD8?style=flat&logo=go)
![Temporal](https://img.shields.io/badge/Temporal-Orchestration-blue?style=flat&logo=temporal)
![MySQL](https://img.shields.io/badge/MySQL-8%2E0-4479A1?style=flat&logo=mysql)
![GORM](https://img.shields.io/badge/GORM-ORM-red?style=flat)
![Gin](https://img.shields.io/badge/Gin-Web_Framework-00ADD8?style=flat&logo=go)


**OmniFlow** æ˜¯ä¸€ä¸ªåŸºäº **Temporal** å’Œ **Go** æ„å»ºçš„ã€å…·å¤‡é«˜å¯é æ€§çš„åˆ†å¸ƒå¼è®¢å•å±¥çº¦å¼•æ“ã€‚
æœ¬é¡¹ç›®æ¼”ç¤ºäº†å¦‚ä½•åœ¨å¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé€šè¿‡ **Saga æ¨¡å¼** è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ï¼Œåˆ©ç”¨ **MySQL æ‚²è§‚é”** è§£å†³é«˜å¹¶å‘åº“å­˜æ‰£å‡é—®é¢˜ï¼Œå¹¶åŸºäº **Event Sourcing** æœºåˆ¶å®ç°äº†é•¿è¿è¡Œæµç¨‹çš„æŒä¹…åŒ–ä¸å®¹é”™ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§ (Key Features)

* **ğŸ’ åŒæ•°æ®åº“æ¶æ„**: **Temporal (PostgreSQL)** è´Ÿè´£æµç¨‹çŠ¶æ€æŒä¹…åŒ–ï¼Œ**ä¸šåŠ¡å±‚ (MySQL)** è´Ÿè´£èµ„äº§æ•°æ®å­˜å‚¨ï¼Œå½»åº•è§£è€¦ã€‚
* **ğŸ›¡ï¸ å¼ºä¸€è‡´æ€§å¹‚ç­‰ (Idempotency Framework)**: è‡ªç ”åŸºäº MySQL å”¯ä¸€é”® + äº‹åŠ¡åŸå­æ€§çš„ `dedup` ä¸­é—´ä»¶ï¼Œå®Œç¾è§£å†³åˆ†å¸ƒå¼é‡è¯•å¯¼è‡´çš„â€œèµ„äº§é‡å¤æ‰£å‡â€é—®é¢˜ã€‚
* **ğŸ”’ é«˜å¹¶å‘é˜²è¶…å–**: åœ¨ Activity ä¸­é›†æˆ `SELECT ... FOR UPDATE` æ‚²è§‚é”ï¼Œç¡®ä¿åœ¨é«˜å¹¶å‘ç§’æ€åœºæ™¯ä¸‹çš„åº“å­˜æ•°æ®å‡†ç¡®æ€§ã€‚
* **ğŸ”„ åˆ†å¸ƒå¼äº‹åŠ¡ (Saga Pattern)**: æ”¯ä»˜å¤±è´¥æˆ–é£æ§æ‹’ç»æ—¶ï¼Œè‡ªåŠ¨è§¦å‘è¡¥å¿æµç¨‹ï¼ˆCompensationsï¼‰ï¼Œå›æ»šå·²æ‰£å‡çš„åº“å­˜ã€‚
* **ğŸ§© å¤æ‚æµç¨‹ç¼–æ’**:
    * **Child Workflows**: å®ç°æ‹†å•é€»è¾‘ï¼Œå¹¶è¡Œå¤„ç†å¤šä»“åº“å‘è´§ï¼ˆFan-out/Fan-inï¼‰ã€‚
    * **Human-in-the-Loop**: å¤§é¢è®¢å•è‡ªåŠ¨æŒ‚èµ·ï¼Œç­‰å¾…äººå·¥é€šè¿‡ API å®¡æ ¸ã€‚
    * **Durable Timers**: åŸºäºæŒä¹…åŒ–å®šæ—¶å™¨çš„è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆæœºåˆ¶ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ (Architecture)

```text
OmniFlow/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ api-server/      # [å…¥å£] Gin HTTP ç½‘å…³ (Port 8000)
â”‚   â””â”€â”€ worker/          # [å…¥å£] Temporal Worker (å« DB åˆå§‹åŒ–ä¸è‡ªåŠ¨è¿ç§»)
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ app/             # [ä¸šåŠ¡å±‚]
â”‚   â”‚   â”œâ”€â”€ activities.go      # åŒ…å« GORM äº‹åŠ¡ã€é”æœºåˆ¶çš„ä¸šåŠ¡åŠ¨ä½œ
â”‚   â”‚   â”œâ”€â”€ workflow.go        # ä¸»æµç¨‹ç¼–æ’ (Saga, Signal, Timer)
â”‚   â”‚   â””â”€â”€ workflow_child.go  # å­æµç¨‹ (å¹¶è¡Œå‘è´§)
â”‚   â”œâ”€â”€ common/          # [æ¨¡å‹å±‚] é€šç”¨ç»“æ„ä½“
â”‚   â””â”€â”€ pkg/
â”‚       â””â”€â”€ dedup/       # [æ ¸å¿ƒç»„ä»¶] å¹‚ç­‰æ€§æ‰§è¡Œå™¨ä¸­é—´ä»¶
â”œâ”€â”€ docker-compose.yml   # åŸºç¡€è®¾æ–½ (MySQL 8 + Temporal + PostgreSQL)
â””â”€â”€ go.mod

```

## ğŸ“– æ ¸å¿ƒåŸç†è§£æ (Under the Hood)

OmniFlow ä¹‹æ‰€ä»¥èƒ½å¤„ç†é•¿è¾¾æ•°å¤©çš„è®¢å•æµç¨‹ä¸”ä¸æ€•å®•æœºï¼Œå½’åŠŸäº Temporal çš„ **Event Sourcing (äº‹ä»¶æº¯æº)** å’Œ **Replay (é‡æ”¾)** æœºåˆ¶ã€‚

### 1. ä¸ºä»€ä¹ˆ Worker æŒ‚äº†æµç¨‹ä¸æ–­ï¼Ÿ(The Replay Mechanism)

åœ¨ OmniFlow ä¸­ï¼ŒWorkflow ä»£ç çš„æ‰§è¡ŒçŠ¶æ€å¹¶ä¸å­˜å‚¨åœ¨ Worker çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯ä»¥ **Event History** çš„å½¢å¼æŒä¹…åŒ–åœ¨ Temporal Server çš„æ•°æ®åº“é‡Œã€‚

å½“ Worker å´©æºƒé‡å¯åï¼Œå®ƒä¼šæ‰§è¡Œä»¥ä¸‹â€œå¤æ´»â€æ­¥éª¤ï¼š

1. ä» Server æ‹‰å–è¯¥è®¢å•çš„å®Œæ•´**äº‹ä»¶å†å²**ã€‚
2. **Replay (é‡æ”¾)**ï¼šä»ç¬¬ä¸€è¡Œä»£ç å¼€å§‹é‡æ–°æ‰§è¡Œ Workflow å‡½æ•°ã€‚
3. **Check History**ï¼šæ¯å½“é‡åˆ° `ExecuteActivity` æˆ– `NewTimer` ç­‰å‘½ä»¤æ—¶ï¼ŒWorker ä¸ä¼šçœŸå»æ‰§è¡Œï¼Œè€Œæ˜¯æ£€æŸ¥å†å²è®°å½•ã€‚
* å¦‚æœå†å²æ˜¾ç¤ºâ€œå·²å®Œæˆâ€ï¼Œç›´æ¥ä½¿ç”¨å†å²ç»“æœï¼Œ**å¿«è¿›**åˆ°ä¸‹ä¸€è¡Œã€‚
* å¦‚æœå†å²æ˜¾ç¤ºâ€œæœªæ‰§è¡Œâ€ï¼Œåˆ™å‘èµ·çœŸæ­£çš„è°ƒç”¨ã€‚



```mermaid
sequenceDiagram
    participant Worker as Worker (Go Code)
    participant History as Event History (DB)
    
    Note over Worker: Worker å´©æºƒé‡å¯...
    Worker->>History: 1. æ‹‰å–å†å²æ—¥å¿—
    History-->>Worker: [Event1: StockReserved, Event2: TimerStarted]
    
    Note over Worker: 2. å¼€å§‹ Replay (é‡æ”¾)
    Worker->>Worker: æ‰§è¡Œ Step 1: é¢„å åº“å­˜
    Worker->>History: è¿™ä¸€æ­¥åšè¿‡å—ï¼Ÿ
    History-->>Worker: åšè¿‡äº† (Event1)ï¼Œç»“æœæ˜¯ nil
    Note over Worker: è·³è¿‡ Activityï¼Œç›´æ¥ç»§ç»­
    
    Worker->>Worker: æ‰§è¡Œ Step 2: å¯åŠ¨å®šæ—¶å™¨
    Worker->>History: è¿™ä¸€æ­¥åšè¿‡å—ï¼Ÿ
    History-->>Worker: åšè¿‡äº† (Event2)ï¼Œå®šæ—¶å™¨å·²åœ¨è¿è¡Œ
    
    Note over Worker: Replay ç»“æŸï¼Œæ¢å¤åˆ°å´©æºƒå‰çŠ¶æ€
    Worker->>Worker: ç»§ç»­ç­‰å¾… Signal æˆ– Timer...

```

### 2. å®šæ—¶å™¨æ˜¯å¦‚ä½•æŒä¹…åŒ–çš„ï¼Ÿ(Durable Timers)

åœ¨ä»£ç ä¸­è°ƒç”¨çš„ `workflow.NewTimer(ctx, 30*time.Minute)` **ä¸æ˜¯** å†…å­˜ä¸­çš„ `time.Sleep`ã€‚

* å®ƒåœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†ä¸€æ¡â€œå°†åœ¨ 30åˆ†é’Ÿåè§¦å‘â€çš„è®°å½•ã€‚
* å³ä½¿æ‰€æœ‰æœåŠ¡å™¨æ–­ç”µï¼Œåªè¦æ•°æ®åº“è¿˜åœ¨ï¼Œç³»ç»Ÿé‡å¯å Temporal Server ä¼šæ‰«æå¹¶å‘ç°â€œè¿‡æœŸçš„å®šæ—¶å™¨â€ï¼Œç«‹å³å”¤é†’ Worker ç»§ç»­æ‰§è¡Œè¶…æ—¶é€»è¾‘ã€‚

---

## â“ æ·±åº¦é—®ç­” (FAQ)

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ MySQL åšå¹‚ç­‰æ€§ï¼Œè€Œä¸æ˜¯ Redisï¼Ÿ

ä¸ºäº†ä¿è¯**é‡‘èçº§çš„æ•°æ®ä¸€è‡´æ€§**ã€‚
å¦‚æœä½¿ç”¨ Redis åšé”ï¼Œä¼šé¢ä¸´â€œRedis å†™å…¥æˆåŠŸä½† MySQL å†™å…¥å¤±è´¥â€çš„åŒå†™ä¸ä¸€è‡´é£é™©ã€‚
OmniFlow é‡‡ç”¨ **Local Transaction Table** æ¨¡å¼ï¼Œå°†â€œå»é‡é”®çš„æ’å…¥â€ä¸â€œåº“å­˜æ‰£å‡â€æ”¾åœ¨åŒä¸€ä¸ª MySQL äº‹åŠ¡ä¸­ã€‚æ ¹æ® ACID ç‰¹æ€§ï¼Œä¸¤è€…è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å›æ»šï¼Œå½»åº•æ ¹é™¤äº†æ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½æ€§ã€‚

### Q2: æ—¢ç„¶ Workflow æ˜¯æŒä¹…åŒ–çš„ï¼Œä¼šä¸ä¼šå‡ºç°äº‹ä»¶ä¸¢å¤±ï¼Ÿ

**ä¸ä¼šã€‚**
Temporal éµå¾ª **Write-Ahead Logging** åŸåˆ™ã€‚ä»»ä½• Signalï¼ˆä¿¡å·ï¼‰æˆ– State Changeï¼ˆçŠ¶æ€å˜æ›´ï¼‰åœ¨ç¡®è®¤ç»™å®¢æˆ·ç«¯ä¹‹å‰ï¼Œå¿…é¡»å…ˆå†™å…¥ DBï¼ˆPostgreSQLï¼‰ã€‚

* å¦‚æœ Worker æŒ‚äº†ï¼šä»»åŠ¡è¿˜åœ¨ Task Queue é‡Œï¼Œä¼šè¢«å…¶ä»– Worker æ¥ç®¡ã€‚
* å¦‚æœ Server æŒ‚äº†ï¼šæ•°æ®åœ¨ DB é‡Œï¼Œæ–°å¯åŠ¨çš„ Server ä¼šè¯»å–æ•°æ®æ¢å¤çŠ¶æ€ã€‚
* å”¯ä¸€çš„æ•°æ®ä¸¢å¤±é£é™©åœ¨äºåº•å±‚æ•°æ®åº“ï¼ˆPostgreSQL/MySQLï¼‰å‘ç”Ÿç‰©ç†æŸåã€‚

### Q3: ä¸ºä»€ä¹ˆåº“å­˜æ‰£å‡è¦åŠ æ‚²è§‚é”ï¼Ÿ

Temporal ä¿è¯ Workflow çš„ä¸²è¡Œæ‰§è¡Œï¼Œä½† **Activities æ˜¯å¹¶å‘æ‰§è¡Œçš„**ã€‚
åœ¨é«˜å¹¶å‘æŠ¢è´­åœºæ™¯ä¸‹ï¼Œå¤šä¸ªè®¢å•å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒçš„åº“å­˜å€¼ï¼ˆRead Skewï¼‰ã€‚æˆ‘ä»¬åœ¨ GORM ä¸­ä½¿ç”¨äº† `clause.Locking{Strength: "UPDATE"}`ï¼Œè¿™å¯¹åº” SQL çš„ `SELECT ... FOR UPDATE`ï¼Œå°†å¹¶å‘çš„åº“å­˜æ‰£å‡æ“ä½œåœ¨æ•°æ®åº“å±‚é¢ä¸²è¡ŒåŒ–ï¼Œé˜²æ­¢è¶…å–ã€‚

---

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹ (Getting Started)

### 1. å¯åŠ¨åŸºç¡€è®¾æ–½

```bash
docker-compose up -d
```

*æ³¨æ„ï¼šé¦–æ¬¡å¯åŠ¨ MySQL å¯èƒ½éœ€è¦å‡ åç§’åˆå§‹åŒ–ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚*

### 2. å¯åŠ¨ Worker

Worker ä¼šè‡ªåŠ¨è¿æ¥ MySQLï¼Œåˆ›å»º `products` å’Œ `idempotency_logs` è¡¨ï¼Œå¹¶åˆå§‹åŒ–æµ‹è¯•æ•°æ®ã€‚

```bash
go run cmd/worker/main.go
```

### 3. å¯åŠ¨ API Server

å¯åŠ¨ Web æœåŠ¡ç›‘å¬ **8000** ç«¯å£ã€‚

```bash
go run cmd/api-server/main.go
```

## ğŸ§ª åœºæ™¯æ¼”ç¤º

### åœºæ™¯ A: æ­£å¸¸ä¸‹å•ä¸å¹¶å‘æ‰£åº“

```bash
curl -X POST http://localhost:8000/api/v1/orders -d '{"amount": 500, "items": ["iPhone15"]}'
```

### åœºæ™¯ B: å¤§é¢è®¢å•é£æ§ (Saga å›æ»š)

```bash
# ä¸‹å• > 10000 å…ƒ
curl -X POST http://localhost:8000/api/v1/orders -d '{"amount": 20000, "items": ["MacPro"]}'
# çŠ¶æ€å˜ä¸º "å¾…é£æ§å®¡æ ¸"ã€‚ç®¡ç†å‘˜è°ƒç”¨æ¥å£æ‹’ç»ï¼š
curl -X POST http://localhost:8000/api/v1/orders/{ORDER_ID}/audit -d '{"action": "REJECT"}'
# ç»“æœ: è§¦å‘ Saga è¡¥å¿ï¼ŒMySQL åº“å­˜è‡ªåŠ¨å›æ»šã€‚
```